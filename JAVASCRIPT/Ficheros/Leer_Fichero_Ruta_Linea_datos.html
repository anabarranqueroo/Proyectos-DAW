<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Ejemplo de acceso a fichero XML (local)</title>
</head>

<style>
	#divmapa {
		width: 700px;
		height: 700px;
		border: 1px solid blue;
	}
</style>

<script async
	src="http://maps.google.com/maps/api/js?loading=async&callback=initMap&key=AIzaSyBkLVi_r1R_D--DoxF9VW98oaBK5QcNFos&libraries=marker,geometry">
	</script>
<script>
	//Contenido xml del GPX.
	var xml = null;
	//Array para la línea de puntos.
	var puntosRuta = [];

	window.onload = function () {
		document.getElementById("id_fichero").addEventListener('change', Leer_Fichero, false);
	}

	//Confirmamos que ha cargado el mapa de la API.
	function initMap() {
		console.log("Mapa cargado");
	}

	//DIBUJO DEL MAPA.
	function CargarMapa() {
		var divMapa = document.getElementById("divmapa");

		//Opciones del mapa.
		var opciones = {
			center: { lat: 0, lng: 0 },
			zoom: 12,
			mapId: "mapa1"
		}

		//Creamos el mapa.
		var mapa = new google.maps.Map(divMapa, opciones);

		//Cogemos los elementos trkpt del xml.
		var trkpts = xml.getElementsByTagName("trkpt");

		//Ajustamos el zoom para que se vea la ruta.
		var bounds = new google.maps.LatLngBounds();

		console.log("Numero de puntos:", trkpts.length);

		for (var i = 0; i < trkpts.length; i++) {
			//Pasa los lat y lon del xml a variables.
			var lat = parseFloat(trkpts[i].getAttribute("lat"));
			var lon = parseFloat(trkpts[i].getAttribute("lon"));
			//Cogemos la posicion.
			var pos = new google.maps.LatLng(lat, lon);

			//Guardamos el punto en la ruta.
			puntosRuta.push(pos);

			//Hace que se vea la posición.
			bounds.extend(pos);

			//Linea de la ruta del mapa
			var lineaRuta = new google.maps.Polyline({
				path: puntosRuta,
				strokeColor: '#FF0000',
				strokeOpacity: 1.0,
				strokeWeight: 1
			});

			lineaRuta.setMap(mapa);
		}
		//Ajusta el zoom y centra el mapa para la ruta completa.
		mapa.fitBounds(bounds);
	}

	//LEER EL FICHERO.

	//Lee el fichero.
	function Leer_Fichero(e) {
		console.log("e.target.files: ", e.target.files);
		var fichero = e.target.files[0];

		//Reader.
		var lector = new FileReader();
		lector.onload = function (e) {
			tratarFichero(lector.result);
			//Pasa a XML.
			xml = ConvertiraXML(lector.result);
			console.log("xml: ", xml);
			CargarMapa();
		}
		lector.readAsText(fichero);
	}

	// Coge la información del fichero.
	const tratarFichero = (contenido) => {
		console.log("datos: ", contenido);
		var cont = document.getElementById("sal");
		var cont2 = document.getElementById("datoscamino");
		cont.innerHTML = "";
		cont2.innerHTML = "";

		// Convertimos el contenido a XML
		var xmlTemp = ConvertiraXML(contenido);

		//Cogemos los elementos trkpt.
		var trkpts = xmlTemp.getElementsByTagName("trkpt");

		//Array de puntos para la distancia total.
		var puntos = [];

		//Recorremos y añadimos lat y lon al div.
		for (var i = 0; i < trkpts.length; i++) {
			var lat = parseFloat(trkpts[i].getAttribute("lat"));
			var lon = parseFloat(trkpts[i].getAttribute("lon"));

			//TIEMPO.
			//Obtenemos el tiempo de cada punto.
			var time = new Date(trkpts[i].getElementsByTagName("time")[0].textContent);
			//Añadimos al array la lat y lon (puntos).
			puntos.push(new google.maps.LatLng(lat, lon));
			//Guardamos el tiempo en el punto.
			puntos[puntos.length - 1].tiempo = time;
			
			cont.innerHTML += "Latitud: " + lat + " Longitud: " + lon + "<br>";
		}

		//DISTANCIA.
		//Distancia en metros.
		var distanciaTotal = google.maps.geometry.spherical.computeLength(puntos);
		console.log("Metros totales: ",distanciaTotal);
		//En km.
		distanciaTotal = distanciaTotal / 1000;
		console.log("Km totales: ",distanciaTotal);

		//VELOCIDAD.
		//Tiempo total en seg
		var tiempoTotalSeg = (puntos[puntos.length - 1].tiempo - puntos[0].tiempo) / 1000;
		console.log("Tiempo en seg:", tiempoTotalSeg);
		//Km/h
		var velocidad = distanciaTotal / (tiempoTotalSeg / 3600);
		console.log("Km/h: ", velocidad);
		//Convierte a formato de horas.
		var h = Math.floor(tiempoTotalSeg / 3600);
		var m = Math.floor((tiempoTotalSeg % 3600) / 60);
		var s = Math.floor(tiempoTotalSeg % 60);

		cont2.innerHTML += "<br><b>Distancia total:</b> " + distanciaTotal.toFixed(2) + " km<br>" +
			"<b>Duración de la ruta:</b> " + h + ":"+ m + ":"+ s + "<br>" + 
			"<b>Velocidad media:</b> " +velocidad.toFixed(2)+" km/h." ;
	}

	// Convierte el archivo a XML.
	function ConvertiraXML(texto) {
		var xml = new DOMParser().parseFromString(texto, "text/xml");
		return xml;
	}

</script>

<body>

	<p>
		<label for="id_fichero">Selecciona el fichero a leer:</label><br>
		<input id="id_fichero" type="file" />
	</p>

	<div id="datoscamino">
		<b>Información del camino:</b>
	</div>
	<div id="divmapa">
	</div>
	<div id="sal">
		-- Aqui va el contenido del archivo --
	</div>


</body>

</html>