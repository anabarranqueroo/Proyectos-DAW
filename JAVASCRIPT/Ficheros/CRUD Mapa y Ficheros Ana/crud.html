<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rutas - CRUD + Google Maps</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px
        }

        #map {
            width: 700px;
            height: 700px;
            border: 1px solid blue;
        }


        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left
        }

        th {
            background: #eee
        }

        button {
            cursor: pointer
        }
    </style>
</head>

<script async
    src="http://maps.google.com/maps/api/js?loading=async&callback=initMap&key=AIzaSyBkLVi_r1R_D--DoxF9VW98oaBK5QcNFos&libraries=marker,geometry">
    </script>
<script>
    window.onload = function () {
        document.getElementById("id_fichero").addEventListener('change', Leer_Fichero, false);
        document.getElementById("btnRegistrar").onclick = RegistrarRuta;
        cargaTabla();
    }

    function initMap() {
        console.log("Mapa cargado");
    }

    var puntosRuta = [];
    var xml = null;
    var tiempo = "0";
    var distancia = 0.0;
    var v = 0.0;
    var url = "api.php";

    function Leer_Fichero(e) {
        console.log("e.target.files: ", e.target.files);
        var fichero = e.target.files[0];

        var lector = new FileReader();
        lector.onload = function (e) {
            tratarFichero(lector.result);
            xml = ConvertiraXML(lector.result);
            console.log("xml: ", xml);
        }
        lector.readAsText(fichero);
    }

    function ConvertiraXML(texto) {
        var xml = new DOMParser().parseFromString(texto, "text/xml");
        return xml;
    }

    const tratarFichero = (contenido) => {
        console.log("datos: ", contenido);
        var xmlTemp = ConvertiraXML(contenido);
        var trkpts = xmlTemp.getElementsByTagName("trkpt");
        console.log("trkpts leídos:", trkpts.length);
        var puntos = [];
        for (var i = 0; i < trkpts.length; i++) {
            var lat = parseFloat(trkpts[i].getAttribute("lat"));
            var lon = parseFloat(trkpts[i].getAttribute("lon"));
            //Tiempo
            var time = new Date(trkpts[i].getElementsByTagName("time")[0].textContent);

            var punto = new google.maps.LatLng(lat, lon);
            punto.tiempo = time;

            puntos.push(punto);
            //Distancia.
            distancia = google.maps.geometry.spherical.computeLength(puntos) / 1000;
            //Velocidad
            var tiempoTotalSeg = (puntos[puntos.length - 1].tiempo - puntos[0].tiempo) / 1000;

            v = (distancia / (tiempoTotalSeg / 3600)).toFixed(2);

            var h = Math.floor(tiempoTotalSeg / 3600);
            var m = Math.floor((tiempoTotalSeg % 3600) / 60);
            var s = Math.floor(tiempoTotalSeg % 60);
            //Variables.
            tiempo = h + ":" + m + ":" + s;
            distancia = distancia.toFixed(2);
            puntosRuta = puntos;
        }

    }

    function cargaTabla() {
        var p = {
            servicio: "listar"
        }

        var parametros = {
            method: 'POST', body: JSON.stringify(p)
        };

        fetch(url, parametros)
            .then(r => r.json())
            .then(datos => creaTabla(datos))
            .then(datos => console.log(datos));
    }
    function CreaFila(aCol, tipo) {
        if (tipo == "cabecera") {
            tipo = "th";
        } else
            tipo = "td";
        var fila = document.createElement("tr");
        var col;
        for (var i = 0; i < aCol.length; i++) {
            col = document.createElement(tipo);
            col.innerHTML = aCol[i];
            fila.appendChild(col);

        }
        return fila;
    }

    function creaTabla(datos) {
        var tabla = document.getElementById("tabla");
        tabla.innerHTML = "";

        for (var i = 0; i < datos.length; i++) {

            var fila = CreaFila([datos[i].nombre, datos[i].duracion, datos[i].distancia, datos[i].velocidad]);

            var tdB = document.createElement("td");
            var botonB = document.createElement("button");

            botonB.innerHTML = "Borrar";
            botonB.onclick = Borrar;
            botonB.dataset.idruta = datos[i].id;
            botonB.dataset.nombreruta = datos[i].nombre;

            tdB.appendChild(botonB);
            fila.appendChild(tdB);

            var tdS = document.createElement("td");
            var botons = document.createElement("button");
            botons.innerHTML = "Seleccionar";
            botons.onclick = Seleccionar;
            botons.dataset.idruta = datos[i].id;
            botons.dataset.nombreruta = datos[i].nombre;
            tdS.appendChild(botons);
            fila.appendChild(tdS);

            tabla.appendChild(fila);

        }

    }

    function RegistrarRuta() {
        var p = {
            servicio: "insertar",
            nombre: document.getElementById("nombre").value,
            duracion: tiempo,
            distancia: distancia,
            velocidad: v,
            path: puntosRuta.map(pt => (
                {
                    lat: pt.lat(),
                    lon: pt.lng()
                }))
        }

        var parametros = {
            method: 'POST', body: JSON.stringify(p)
        };

        fetch(url, parametros)
            .then(r => r.json())
            .then(datos => {
                creaTabla(datos);
            });
    }

    function Seleccionar() {
        var id = this.dataset.idruta;
        var p = {
            servicio: "selRutaID",
            id: id
        };

        var parametros = {
            method: 'POST',
            body: JSON.stringify(p)
        };

        fetch(url, parametros)
            .then(r => r.json())
            .then(datos => {
                console.log("Resp: ", datos);
                var puntosDB = JSON.parse(datos.path);
                console.log("PuntosDB: ", puntosDB);
                puntosRuta = [];
                for (var i = 0; i < puntosDB.length; i++) {
                    var lat = parseFloat(puntosDB[i].lat);
                    var lon = parseFloat(puntosDB[i].lon);
                    puntosRuta.push(new google.maps.LatLng(lat, lon));
                }
                CargarMapa();
            })
    }


    function Borrar(){
        var id = this.dataset.idruta;
        let confirmar = confirm("¿Desea borrar la " + this.dataset.nombreruta + "?");
        if (confirmar) {
                var p = {
                    servicio: "borrar",
                    id: this.dataset.idruta
                }

                var parametros = {
                    method: 'POST', body: JSON.stringify(p)
                };

                fetch(url, parametros)
                    .then(r => r.json())
                    .then(datos => creaTabla(datos));
            }
    }


    function CargarMapa() {
        var divMapa = document.getElementById("map");
        var mapa = new google.maps.Map(divMapa, {
            center: puntosRuta[0],
            zoom: 12,
            mapId: "mapa1"
        });

        var bounds = new google.maps.LatLngBounds();
        for (var i = 0; i < puntosRuta.length; i++) {
            bounds.extend(puntosRuta[i]);
        }
        var lineaRuta = new google.maps.Polyline({
            path: puntosRuta,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });

        lineaRuta.setMap(mapa);
        mapa.fitBounds(bounds);
    }



</script>

<body>
    <h1>Rutas (CRUD con PHP)</h1>


    <label for="id_fichero">Selecciona el fichero a leer:</label><br>
    <input id="id_fichero" type="file" /><br><br>


    <label for="nombre">Nombre de la ruta:</label><br>
    <input id="nombre" type="text" />
    <br><br>
    <button id="btnRegistrar" type="button">Registrar ruta</button>
    <button id="btnActualizar" type="button" style="display:none">Actualizar ruta</button>


    <h3>Rutas Registradas</h3>
    <table>
        <thead>
            <tr>
                <th>Nombre de la ruta</th>
                <th>Duracion</th>
                <th>Kilometros recorridos</th>
                <th>Velocidad</th>
                <th>Borrar ruta</th>
                <th>Seleccionar ruta</th>
            </tr>
        </thead>
        <tbody id="tabla"></tbody>
    </table>

    <h2>Mapa</h2>
    <div id="map"></div>
</body>

</html>