<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Ejemplo de acceso a fichero XML (local)</title>
</head>

<style>
	#divmapa {
		width: 700px;
		height: 700px;
		border: 1px solid blue;
	}
</style>

<script async
	src="http://maps.google.com/maps/api/js?loading=async&callback=initMap&key=AIzaSyBkLVi_r1R_D--DoxF9VW98oaBK5QcNFos&libraries=marker">
	</script>
<script>
	//Contenido xml del GPX.
	var xml = null;

	window.onload = function () {
		document.getElementById("id_fichero").addEventListener('change', Leer_Fichero, false);
	}

	//Confirmamos que ha cargado el mapa de la API.
	function initMap() {
		console.log("Mapa cargado");
	}

	//DIBUJO DEL MAPA.

	function CargarMapa() {
		var divMapa = document.getElementById("divmapa");

		//Opciones del mapa.
		var opciones = {
			center: { lat: 0, lng: 0 },
			zoom: 12,
			mapId: "mapa1"
		}

		//Creamos el mapa.
		var mapa = new google.maps.Map(divMapa, opciones);

		//Cogemos los elementos trkpt del xml.
		var trkpts = xml.getElementsByTagName("trkpt");

		//Ajustamos el zoom para que se vea la ruta.
		var bounds = new google.maps.LatLngBounds();

		console.log("Numero de puntos:", trkpts.length);

		for (var i = 0; i < trkpts.length; i++) {
			//Pasa los lat y lon del xml a variables.
			var lat = parseFloat(trkpts[i].getAttribute("lat"));
			var lon = parseFloat(trkpts[i].getAttribute("lon"));
			//Cogemos la posicion.
			var pos = new google.maps.LatLng(lat, lon);

			//Hace que se vea la posición.
			bounds.extend(pos);

			//Crea el marcador en cada punto.
			new google.maps.marker.AdvancedMarkerElement({
				position: pos,
				map: mapa,
				content: crearIcono("icono.png"),
			});
		}

		// Marcador inicio
		//Lee el primer trkpt del xml
		var inicio = new google.maps.LatLng(parseFloat(trkpts[0].getAttribute("lat")), parseFloat(trkpts[0].getAttribute("lon")));
		//Hace que se vea.
		bounds.extend(inicio);

		//Dibuja el marcador de inicio.
		new google.maps.marker.AdvancedMarkerElement({
			position: inicio,
			map: mapa,
			title: "Inicio de la ruta", 
			content: crearIcono("inicio.png"),
		});

		// Marcador final
		//Lee el último trkpt del xml
		var fin = new google.maps.LatLng(parseFloat(trkpts[trkpts.length - 1].getAttribute("lat")), parseFloat(trkpts[trkpts.length - 1].getAttribute("lon")));
		//Hace que se vea.
		bounds.extend(fin);

		//Dibuja el marcador de fin.
		new google.maps.marker.AdvancedMarkerElement({
			position: fin,
			map: mapa,
			title: "Final de la ruta",
			content: crearIcono("inicio.png"),
		});

		//Ajusta el zoom y centra el mapa para la ruta completa.
		mapa.fitBounds(bounds);
	}

	//FUNCION ICONO MARCADOR MODIFICADO.	
	function crearIcono(url, ancho = 22, alto = 22) {
		var img = document.createElement("img");
		img.src = url;
		img.style.width = ancho + "px";
		img.style.height = alto + "px";
		return img;
	}

	//LEER EL FICHERO.

	//Lee el fichero.
	function Leer_Fichero(e) {
		console.log("e.target.files: ", e.target.files);
		var fichero = e.target.files[0];

		//Reader.
		var lector = new FileReader();
		lector.onload = function (e) {
			tratarFichero(lector.result);
			//Pasa a XML.
			xml = ConvertiraXML(lector.result);
			console.log("xml: ", xml);
			CargarMapa();
		}
		lector.readAsText(fichero);
	}

	// Coge la información del fichero.
	const tratarFichero = (contenido) => {
		console.log("datos: ", contenido);
		var cont = document.getElementById("sal");
		cont.innerHTML = "";

		// Convertimos el contenido a XML
		var xmlTemp = ConvertiraXML(contenido);

		//Cogemos los elementos trkpt.
		var trkpts = xmlTemp.getElementsByTagName("trkpt");

		//Recorremos y añadimos lat y lon al div.
		for (var i = 0; i < trkpts.length; i++) {
			var lat = trkpts[i].getAttribute("lat");
			var lon = trkpts[i].getAttribute("lon");
			cont.innerHTML += "Latitud: " + lat + " Longitud: " + lon + "<br>";
		}


	}

	// Convierte el archivo a XML.
	function ConvertiraXML(texto) {
		var xml = new DOMParser().parseFromString(texto, "text/xml");
		return xml;
	}

</script>

<body>

	<p>
		<label for="id_fichero">Selecciona el fichero a leer:</label><br>
		<input id="id_fichero" type="file" />
	</p>
	<div id="divmapa">
	</div>
	<div id="sal">
		-- Aqui va el contenido del archivo --
	</div>
</body>

</html>