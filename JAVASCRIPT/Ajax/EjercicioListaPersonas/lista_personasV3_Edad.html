<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Ejercicio Listado Personas. AJAX</title>
    <style type="text/css">
        h3 {
            color: red;
        }

        /* CSS para el formulario:   */
        .formPersonas {
            visibility: hidden;
            position: absolute;
            top: 20%;
            left: 20%;
            z-index: 11;
            background-color: pink;
            border: 2px solid maroon;
            border-radius: 15px;
            padding: 1em;
            color: red;

            /*	opacity:0;   */
            /*	transition: all 1s;   */
        }

        .formPersonas div label {
            display: block;
            margin-top: .5em;
        }

        .formPersonas .btn {
            display: block;
            margin-top: 1em;
        }


        .ver {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <script type="text/javascript">

        var url = "servidor2.php";

        window.onload = function () {
            cargaTabla();
            document.getElementById("btNuevaPersona").onclick = mostrarFormulario;
            document.getElementById("btCancelar").onclick = cancelarFormulario;
            document.getElementById("btAnade").onclick = anadir;


        }

        //Funcion que carga los datos.
        function cargaTabla() {
            var p = {
                servicio: "listar"
            }

            var parametros = {
                method: 'POST', body: JSON.stringify(p)
            };

            fetch(url, parametros)
                .then(r => r.json())
                .then(datos => creaTabla(datos))
                .then(datos => console.log(datos));
        }

        //Funcion que crea la tabla.
        function CreaFila(aCol, tipo) {
            if (tipo == "cabecera") {
                tipo = "th";
            } else
                tipo = "td";
            var fila = document.createElement("tr");
            var col;
            for (var i = 0; i < aCol.length; i++) {
                col = document.createElement(tipo);
                col.innerHTML = aCol[i];
                fila.appendChild(col);

            }
            return fila;
        }
        function creaTabla(datos) {
            var tabla = document.getElementById("filas_tabla");
            tabla.innerHTML = "";

            for (var i = 0; i < datos.length; i++) {
                var cumple = CalculaEdad(datos[i].FECNAC);
                var fila = CreaFila([datos[i].ID, datos[i].DNI, datos[i].NOMBRE, datos[i].APELLIDOS, cumple]);

                //Crea botones de Borrar y Editar.
                var tdB = document.createElement("td");
                var botonB = document.createElement("button");
                var tdE = document.createElement("td");

                botonB.innerHTML = "Borrar";
                botonB.onclick = Borrar;
                botonB.dataset.idpersona = datos[i].ID;
                botonB.dataset.nombreape = datos[i].NOMBRE + " " + datos[i].APELLIDOS;

                tdB.appendChild(botonB);
                fila.appendChild(tdB);

                var botonE = document.createElement("button");
                botonE.dataset.idpersona = datos[i].ID;
                botonE.innerHTML = "Editar";
                botonE.onclick = Editar;

                tdE.appendChild(botonE);
                fila.appendChild(tdE);

                //Añade la fila a la tabla.
                tabla.appendChild(fila);

            }

        }

        //Funcion borrar usuario.
        function Borrar(id) {
            let confirmar = confirm("¿Desea borrar a " + this.dataset.nombreape + "?");

            if (confirmar) {
                var p = {
                    servicio: "borrar",
                    id: this.dataset.idpersona
                }

                var parametros = {
                    method: 'POST', body: JSON.stringify(p)
                };

                fetch(url, parametros)
                    .then(r => r.json())
                    .then(datos => creaTabla(datos));
            }
        }


        //Funciones de mostrar y quitar formulario de alta de usuario.
        function mostrarFormulario() {
            document.getElementById("btAnade").textContent = "Añadir";
            document.getElementById("formPersonas").classList.add("ver");
            //Formulario vacío.
            document.getElementById("dni").value = "";
            document.getElementById("nombre").value = "";
            document.getElementById("apellidos").value = "";
            //Asigna al boton de añadir un -1 para saber que está añadiendo.
            document.getElementById("btAnade").dataset.idpersona = -1;
        }

        function cancelarFormulario() {
            document.getElementById("formPersonas").classList.remove("ver");
        }

        function CalculaEdad(fecha) {

            var nacimiento = new Date(fecha);
            var hoy = new Date();
            var edad = hoy.getFullYear() - nacimiento.getFullYear();

            // Ajustar si aún no ha cumplido años este año
            if (
                hoy.getMonth() < nacimiento.getMonth() ||
                (hoy.getMonth() === nacimiento.getMonth() && hoy.getDate() < nacimiento.getDate())
            ) {
                edad--;
            }

            return edad;


        }

        //Funcion alta de usuario.
        function anadir() {

            //Comprueba si es -1, se añade la persona, si no, se edita.
            if (this.dataset.idpersona == -1) {

                var p = {
                    servicio: "insertar",
                    dni: document.getElementById("dni").value,
                    nombre: document.getElementById("nombre").value,
                    apellidos: document.getElementById("apellidos").value,
                    edad: document.getElementById("fechanac").value
                }

                var parametros = {
                    method: 'POST', body: JSON.stringify(p)
                };

                fetch(url, parametros)
                    .then(r => r.json())
                    .then(datos => {
                        cancelarFormulario();
                        creaTabla(datos);
                    });

            } else {

                var p = {
                    servicio: "modificar",
                    id: this.dataset.idpersona,
                    dni: document.getElementById("dni").value,
                    nombre: document.getElementById("nombre").value,
                    apellidos: document.getElementById("apellidos").value,
                    edad: document.getElementById("fechanac").value
                }

                var parametros = {
                    method: 'POST', body: JSON.stringify(p)
                };

                fetch(url, parametros)
                    .then(r => r.json())
                    .then(datos => {
                        cancelarFormulario();
                        creaTabla(datos);
                    });
            }

        }

        function Editar() {
            document.getElementById("btAnade").textContent = "Modificar";
            var p = {
                servicio: "selPersonaID",
                id: this.dataset.idpersona
            };

            var parametros = {
                method: 'POST',
                body: JSON.stringify(p)
            };

            fetch(url, parametros)
                .then(r => r.json())
                .then(datos => {
                    //Cuando le das a editar, hace que aparezcan los datos de la persona seleccionada.
                    document.getElementById("dni").value = datos.DNI;
                    document.getElementById("nombre").value = datos.NOMBRE;
                    document.getElementById("apellidos").value = datos.APELLIDOS;
                    document.getElementById("btAnade").dataset.idpersona = datos.ID;
                    document.getElementById("fechanac").value = datos.FECNAC;
                    document.getElementById("formPersonas").classList.add("ver");
                })
        }


    </script>
</head>

<body>
    <h3>Registro de Usuarios</h3>

    <div id="formPersonas" class="formPersonas">
        <fieldset>
            <legend>Alta en el servicio</legend>
            <div>
                <label for="dni">DNI</label>
                <input type="text" id="dni" size="10" maxlength="9" value="27473339T" />
            </div>
            <div>
                <label for="nombre">Nombre</label>
                <input type="text" id="nombre" value="Marco Elio" />
            </div>
            <div>
                <label for="apellidos">Apellidos</label>
                <input type="text" id="apellidos" size="40" value="García Gomariz" />
            </div>
            <div>
                <label for="fecha">Fecha Nacimiento</label>
                <input type="date" id="fechanac" />
            </div>
            <div class="btn">
                <button id="btAnade">Añadir </button>
                <button id="btCancelar">Cancelar </button>
            </div>
        </fieldset>
    </div>

    <br />
    <button class="btn" id="btNuevaPersona">Nueva persona</button>
    <br><br>
    <table id="tabla_personas" border="1">
        <tr>
            <th>ID</th>
            <th>DNI</th>
            <th>NOMBRE</th>
            <th>APELLIDOS</th>
            <th>EDAD</th>

            <th>Borrar</th>
            <th>Editar</th>
        </tr>

        <tbody id="filas_tabla">

        </tbody>
    </table>

    <br><br>

</body>

</html>