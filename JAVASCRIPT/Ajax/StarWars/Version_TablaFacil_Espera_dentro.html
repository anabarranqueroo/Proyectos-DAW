<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Envio de parametros con AJAX externo</title>
	<style type="text/css">
		.estilo_Tabla_1 {
			font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
			width: 70%;
			border-collapse: collapse;
		}

		.estilo_Tabla_1 td {
			font-size: 1em;
			border: 1px solid #98bf21;
			padding: 4px;
		}

		.estilo_Tabla_1 th {
			border: 1px solid #98bf21;
			font-size: 1.2em;
			padding: 5px;
			background-color: #A7C942;
			color: #ffffff;
		}

		.estilo_Tabla_1 tr td {
			color: #000000;

			background-color: #EAF2D3;
		}

		caption {
			caption-side: bottom;
			color: green;
		}

		button {
			background-color: #f4a7a7;
			border: 2px solid #000000;
			border-radius: 12px;
			padding: 8px 15px;
			font-size: 14px;
		}

		img {
			width: 170px;
			height: 150px;
		}

		.carga {
			position: absolute;
			left: 40%;
			top: 25%;
			display: none;
		}
	</style>
	<script type="text/javascript">
		var peti1 = new XMLHttpRequest();
		var peti2 = new XMLHttpRequest();
		let url = "https://swapi.dev/api/people/?format=json";

		var espera;

		window.onload = function () {
			creaEspera(); //funcion de crear espera en el mismo documento.
			cargadatos();
			//cargaPlaneta();
			document.getElementById("btnAnterior").onclick = anterior;
			document.getElementById("btnSiguiente").onclick = siguiente;
		}

		
		function cargadatos() {
			console.log("Aqui cargo todos los datos de cada uno.");
			document.querySelector('.carga').style.display = 'block';
			espera.mostrarEspera();
			peti1.onreadystatechange = llenadatos;
			peti1.open('GET', url);
			peti1.send(null);
		}

		function llenadatos() {
			if ((peti1.readyState == 4) && (peti1.status == 200)) {

				setTimeout(() => {
					document.querySelector('.carga').style.display = 'none';
				}, 2700);

				console.log(peti1.responseText);
				let arDatos = JSON.parse(peti1.responseText);
				let personajes = arDatos.results;
				console.log(personajes);

				//Habilita y deshabilita botones de navegacion.
				if (arDatos.previous === null) {
					document.getElementById("btnAnterior").disabled = true;
				} else {
					document.getElementById("btnAnterior").disabled = false;
				}


				if (arDatos.next === null) {
					document.getElementById("btnSiguiente").disabled = true;
				} else {
					document.getElementById("btnSiguiente").disabled = false;
				}

				var tabla = document.getElementById("cuerpoPersonajes");
				

				tabla.innerHTML = ""; //Limpia la tabla.

				//Crea la tabla de forma fácil.
				for (let i = 0; i < personajes.length; i++) {
					console.log(personajes[i]);

					let personaje = personajes[i];
					let tr = document.createElement("tr");

					let tdNombre = document.createElement("td");
					tdNombre.textContent = personaje.name;

					let tdAltura = document.createElement("td");
					tdAltura.textContent = personaje.height;

					let tdPeso = document.createElement("td");
					tdPeso.textContent = personaje.mass;

					let tdNac = document.createElement("td");
					tdNac.textContent = personaje.birth_year;

					let tdGenero = document.createElement("td");
					tdGenero.textContent = personaje.gender;

					let tdMundo = document.createElement("td");
					let enlace = document.createElement("a");
					enlace.href = personaje.homeworld;
					enlace.textContent = enlace.href;
					tdMundo.appendChild(enlace);

					tr.appendChild(tdNombre);
					tr.appendChild(tdAltura);
					tr.appendChild(tdPeso);
					tr.appendChild(tdNac);
					tr.appendChild(tdGenero);
					tr.appendChild(tdMundo);

					tabla.appendChild(tr);
					enlace.onclick = cargaPlaneta;
				}
				espera.ocultarEspera();
			}
		}




		function cargaPlaneta() {
			espera.mostrarEspera();
			console.log("Aqui cargo todos los datos de cada planeta.");
			let url = this.href;
			console.log(url);
			peti2.onreadystatechange = llenaplanetas;
			peti2.open('GET', url);
			peti2.send(null);
			return false;
		}

		function llenaplanetas() {
			if ((peti2.readyState == 4) && (peti2.status == 200)) {
				console.log(peti2.responseText);
				let planetas = JSON.parse(peti2.responseText);
				console.log(planetas);

				var datos = document.getElementById("datosPlaneta");

				datos.innerHTML =
					"<b>Datos de los planetas:</b><br><br>" +
					"<b>Nombre:</b> " + planetas.name + "<br>" +
					"<b>Periodo rotación:</b> " + planetas.rotation_period + "<br>" +
					"<b>Periodo orbital:</b> " + planetas.orbital_period + "<br>" +
					"<b>Diámetro:</b> " + planetas.diameter + "<br>" +
					"<b>Clima:</b> " + planetas.climate + "<br>" +
					"<b>Gravedad:</b> " + planetas.gravity + "<br>" +
					"<b>Terreno:</b> " + planetas.terrain + "<br><br>";

					espera.ocultarEspera();

			}
		}
		
		//Pasa a la página anterior si .previus tiene enlace.
		function anterior() {
			let arDatos = JSON.parse(peti1.responseText);

			if (arDatos.previous != null) {
				url = arDatos.previous;
				cargadatos();
			}


		}

		//Pasa a la página siguiente si .next tiene enlace.
		function siguiente() {
			let arDatos = JSON.parse(peti1.responseText);

			if (arDatos.next != null) {
				url = arDatos.next;
				cargadatos();
			}
		}

		//Crea el gif de espera sin tocar html y css (Todo lo comentado con clase .carga).
		var div=null;
		function creaEspera(){
			div = document.createElement("div");
			div.style.display = "none";
			document.body.appendChild(div);
			div.style.position = "fixed";
			div.style.top = "25%";
			div.style.left = "40%";
			div.style.width = "170px";
			div.style.height = "150px";
			div.style.background = "url('simpson.gif') center no-repeat";
			div.style.backgroundSize = "100px 100px";
		}

		function mostrarEspera(){
			div.style.display = "block";
		}

		function ocultarEspera(){
			div.style.display = "none";
		}

	</script>
</head>

<body>
	<h3>Ejemplo de llamada a la API de STAR WARS</h3>
	<br>

	<p>
	<table id="personajes" class="estilo_Tabla_1">
		<caption>Personajes STAR WARS</caption>
		<thead>
			<tr>
				<th>Nombre</th>
				<th>Altura</th>
				<th>Peso</th>
				<th>Nacimiento</th>
				<th>Género</th>
				<th>Homeworld</th>
			</tr>
		</thead>
		<tbody id="cuerpoPersonajes">

		</tbody>
	</table>
	</p>
	<div class="carga"><img src="carga.gif" alt="carga"></div> 
	
	<button id="btnAnterior">Anterior</button>
	<button id="btnSiguiente">Siguiente</button>
	<br>
	<br>

	<div id="datosPlaneta">Datos del planeta:</div>
</body>

</html>