<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Envio de parametros con AJAX externo</title>
	<style type="text/css">
		.estilo_Tabla_1 {
			font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
			width: 70%;
			border-collapse: collapse;
		}

		.estilo_Tabla_1 td {
			font-size: 1em;
			border: 1px solid #98bf21;
			padding: 4px;
		}

		.estilo_Tabla_1 th {
			border: 1px solid #98bf21;
			font-size: 1.2em;
			padding: 5px;
			background-color: #A7C942;
			color: #ffffff;
		}

		.estilo_Tabla_1 tr td {
			color: #000000;

			background-color: #EAF2D3;
		}

		caption {
			caption-side: bottom;
			color: green;
		}

		button {
			background-color: #f4a7a7;
			border: 2px solid #000000;
			border-radius: 12px;
			padding: 8px 15px;
			font-size: 14px;
		}

		img {
			width: 170px;
			height: 150px;
		}

		.carga {
			position: absolute;
			left: 40%;
			top: 25%;
			display: none;
		}
	</style>
	<script type="text/javascript" src="Espera.js"> </script> <!-- Unir la clase Espera -->
	<script type="text/javascript">
		let url = "https://swapi.dev/api/people/?format=json";
		var espera;
        let respPersonajes = null;

		window.onload = function () {
			espera = new Espera(); //Crea la espera desde Espera.js
			cargadatos();
			document.getElementById("btnAnterior").onclick = anterior;
			document.getElementById("btnSiguiente").onclick = siguiente;
		}

		//Funcion creaFila a partir de unos datos
		function CreaFila(aCol, tipo){
			if(tipo =="cabecera"){
				tipo = "th";
			}else
				tipo="td";
				var fila = document.createElement("tr");
				var col; 
				for(var i =0; i<aCol.length; i++){
					col = document.createElement(tipo);
					col.innerHTML = aCol[i];
					fila.appendChild(col);
				}
			return fila;		
		}
		function creaTabla(personajes){
			var tabla = document.getElementById("cuerpoPersonajes");
				var link;
				var datospintar = personajes.map(function(d){
					link = '<a href= "'+d.homeworld+'?format=json">'+d.homeworld+'</a>';
					return [d.name, d.height, d.mass, d.birth_year, d.gender, link];
				});
				
				console.log(datospintar);

				tabla.innerHTML = ""; //Limpia la tabla.
				datospintar.forEach(function(d){
					tabla.appendChild(CreaFila(d));
				});
		}
		
		function cargadatos() {
			console.log("Aqui cargo todos los datos de cada uno.", url);
			espera.mostrarEspera();

            fetch(url)
			.then(function (res) {
					return res.json();
				})
				.then(function (res) {
					respPersonajes = res;
                    console.log('respuesta', res);
					llenadatos(res);
				});	
		}

		function llenadatos(personajes) {
                let arDatos = personajes.results;
				console.log(arDatos);

				//Habilita y deshabilita botones de navegacion.
				if (personajes.previous === null) {
					document.getElementById("btnAnterior").disabled = true;
				} else {
					document.getElementById("btnAnterior").disabled = false;
				}


				if (personajes.next === null) {
					document.getElementById("btnSiguiente").disabled = true;
				} else {
					document.getElementById("btnSiguiente").disabled = false;
				}
				

				//Crea la tabla usando la funcion CreaFila y usando .map
				creaTabla(arDatos);
				//Muestra la informacion del enlace sin navegar a la pagina del propio enlace.
				var enlaces = document.querySelectorAll("#cuerpoPersonajes a");
				enlaces.forEach(function(a){
					a.onclick = cargaPlaneta;
				});
				espera.ocultarEspera();
			}

		function cargaPlaneta() {
			espera.mostrarEspera();
			console.log("Aqui cargo todos los datos de cada planeta.");
			let url = this.href;
			console.log(url);
			
            fetch(url)
			.then(function (res) {
					return res.json();
				})
				.then(function (res) {
                    console.log('respuesta', res);
					llenaplanetas(res);
				});

			return false;
		}

		function llenaplanetas(planetas) {
				console.log(planetas);

				var datos = document.getElementById("datosPlaneta");

				datos.innerHTML =
					"<b>Datos de los planetas:</b><br><br>" +
					"<b>Nombre:</b> " + planetas.name + "<br>" +
					"<b>Periodo rotación:</b> " + planetas.rotation_period + "<br>" +
					"<b>Periodo orbital:</b> " + planetas.orbital_period + "<br>" +
					"<b>Diámetro:</b> " + planetas.diameter + "<br>" +
					"<b>Clima:</b> " + planetas.climate + "<br>" +
					"<b>Gravedad:</b> " + planetas.gravity + "<br>" +
					"<b>Terreno:</b> " + planetas.terrain + "<br><br>";

					espera.ocultarEspera();

			}
		
		//Pasa a la página anterior si .previus tiene enlace.
		function anterior() {
			let arDatos = respPersonajes;

			if (arDatos.previous != null) {
				url = arDatos.previous;
				cargadatos();
			}


		}

		//Pasa a la página siguiente si .next tiene enlace.
		function siguiente() {
			let arDatos = respPersonajes;

			if (arDatos.next != null) {
				url = arDatos.next;
				cargadatos();
			}
		}
		var div=null;

	</script>
</head>

<body>
	<h3>Ejemplo de llamada a la API de STAR WARS</h3>
	<br>

	<p>
	<table id="personajes" class="estilo_Tabla_1">
		<caption>Personajes STAR WARS</caption>
		<thead>
			<tr>
				<th>Nombre</th>
				<th>Altura</th>
				<th>Peso</th>
				<th>Nacimiento</th>
				<th>Género</th>
				<th>Homeworld</th>
			</tr>
		</thead>
		<tbody id="cuerpoPersonajes">

		</tbody>
	</table>
	</p>
	
	<button id="btnAnterior">Anterior</button>
	<button id="btnSiguiente">Siguiente</button>
	<br>
	<br>

	<div id="datosPlaneta">Datos del planeta:</div>
</body>

</html>