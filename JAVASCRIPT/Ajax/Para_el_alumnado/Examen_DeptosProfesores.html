<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Examen 1ª Evaluación DWEC</title>
	<style>
		h3 {
			color: red;
		}

		/* CSS para el formulario:   */
		.formProfes {
			visibility: hidden;
			position: absolute;
			top: 20%;
			left: 20%;
			z-index: 11;
			background-color: pink;
			border: 2px solid maroon;
			border-radius: 15px;
			padding: 1em;
			color: red;
		}

		.formProfes div label {
			display: block;
			margin-top: .5em;
		}

		.formProfes .btn {
			display: block;
			margin-top: 1em;
		}


		.ver {
			visibility: visible;
		}


		#deptoDelProfe {
			font-family: "Lucida Console", "Courier New", monospace;
			font-size: 1.2em;
			font-weight: bold;
			color: blue;
		}
	</style>
	<script type="text/javascript">

		var url = "deptosProfes.php";
		var idDeptAct = null;

		window.onload = function () {
			cargaTablaDep();
			document.getElementById("btNuevoDepto").onclick = mostrarFormDept;
			document.getElementById("btCancelarDepto").onclick = cancelarFormDept;
			document.getElementById("btAnadeDepto").onclick = anadirDept;
			document.getElementById("btNuevaProfe").onclick = mostrarFormProf;
			document.getElementById("btCancelar").onclick = cancelarFormProf;
			document.getElementById("btAnade").onclick = anadirProf;
		}

		//Funcion que carga los departamentos.
		function cargaTablaDep() {
			var p = {
				servicio: "departamentos"
			}

			var parametros = {
				method: 'POST', body: JSON.stringify(p)
			};

			fetch(url, parametros)
				.then(r => r.json())
				.then(datos => creaTablaDep(datos))
				.then(datos => console.log(datos));
		}

		//Funcion que crea la tabla.
		function CreaFilaDep(aCol, tipo) {
			if (tipo == "cabecera") {
				tipo = "th";
			} else
				tipo = "td";
			var fila = document.createElement("tr");
			var col;
			for (var i = 0; i < aCol.length; i++) {
				col = document.createElement(tipo);
				col.innerHTML = aCol[i];
				fila.appendChild(col);

			}
			return fila;
		}
		function creaTablaDep(datos) {
			var tbody = document.getElementById("detalle_departamentos");
			tbody.innerHTML = "";

			for (var i = 0; i < datos.length; i++) {

				var fila = CreaFilaDep([datos[i].id, datos[i].nombre, datos[i].descripcion]);

				//Crea boton de seleccionar departamento.
				var tdS = document.createElement("td");
				var botonS = document.createElement("button");

				botonS.innerHTML = "Seleccionar Dept";
				botonS.onclick = cargaselDept;
				botonS.dataset.iddep = datos[i].id;
				botonS.dataset.nombredept = datos[i].nombre;

				tdS.appendChild(botonS);
				fila.appendChild(tdS);

				//Añade la fila a la tabla.
				tbody.appendChild(fila);

			}

		}

		//Funciones de mostrar y quitar formulario de alta de departamento.
		function mostrarFormDept() {
			document.getElementById("formDeptos").classList.add("ver");
		}

		function cancelarFormDept() {
			document.getElementById("formDeptos").classList.remove("ver");
		}

		//Funcion alta de departamento.
		function anadirDept() {
			var p = {
				servicio: "anadeDepto",
				nombre: document.getElementById("nombreDepto").value,
				descripcion: document.getElementById("descripcion").value,
			}

			var parametros = {
				method: 'POST', body: JSON.stringify(p)
			};

			fetch(url, parametros)
				.then(r => r.json())
				.then(datos => {
					cancelarFormDept();
					creaTablaDep(datos);
				});

		}



		/*TABLA PROFESORES*/

		//Funcion que craga los profesores por id del departamento.
		function cargaselDept(e) {
			e.preventDefault();
			var idDep = e.target.dataset.iddep;
			var nombreDept = e.target.dataset.nombredept;

			idDeptAct = idDep;

			document.getElementById("deptoDelProfe").textContent = nombreDept;

			var p = {
				servicio: "profesores",
				id_departamento: idDep
			}

			var parametros = {
				method: 'POST', body: JSON.stringify(p)
			};

			fetch(url, parametros)
				.then(r => r.json())
				.then(datosprof => creaTablaProf(datosprof))
				.then(datosprof => console.log(datosprof));
		}

		//Funcion que crea la tabla.
		function CreaFilaProf(aCol, tipo) {
			if (tipo == "cabecera") {
				tipo = "th";
			} else
				tipo = "td";
			var fila = document.createElement("tr");
			var col;
			for (var i = 0; i < aCol.length; i++) {
				col = document.createElement(tipo);
				col.innerHTML = aCol[i];
				fila.appendChild(col);

			}
			return fila;
		}
		function creaTablaProf(datosprof) {
			var tbody = document.getElementById("detalle_profesores");
			tbody.innerHTML = "";

			for (var i = 0; i < datosprof.length; i++) {

				var fila = CreaFilaProf([datosprof[i].id, datosprof[i].dni, datosprof[i].nombre, datosprof[i].apellidos]);

				//Crea boton de eliminar profesor y modificar.
				var tdE = document.createElement("td");
				var botonE = document.createElement("button");
				var tdEd = document.createElement("td");
				var botonEd = document.createElement("button");

				botonE.innerHTML = "Eliminar";
				botonE.onclick = eliminarProf;
				botonE.dataset.idprof = datosprof[i].id;
				botonE.dataset.nombreape = datosprof[i].nombre + " " + datosprof[i].apellidos;

				botonEd.innerHTML = "Modificar";
				//botonEd.onclick = Modificar;
				botonEd.dataset.idprof = datosprof[i].id;
				botonEd.dataset.nombreape = datosprof[i].nombre + " " + datosprof[i].apellidos;

				tdE.appendChild(botonE);
				tdEd.appendChild(botonEd);
				fila.appendChild(tdE);
				fila.appendChild(tdEd)

				//Añade la fila a la tabla.
				tbody.appendChild(fila);

			}

		}

		//Funciones de mostrar y quitar formulario de alta de profesores.
		function mostrarFormProf() {
			document.getElementById("formProfes").classList.add("ver");
		}

		function cancelarFormProf() {
			document.getElementById("formProfes").classList.remove("ver");
		}


		//Funcion alta de profesores.
		function anadirProf() {
			var p = {
				servicio: "anadeProfe",
				id_departamento: idDeptAct,
				dni: document.getElementById("dni").value,
				nombre: document.getElementById("nombre").value,
				apellidos: document.getElementById("apellidos").value
			}

			var parametros = {
				method: 'POST', body: JSON.stringify(p)
			};

			fetch(url, parametros)
				.then(r => r.json())
				.then(datosprof => {
					cancelarFormProf();
					creaTablaProf(datosprof);
				});

		}

		//Funcion eliminar profesor.
		function eliminarProf(idprof) {

			let confirmar = confirm("¿Desea borrar a " + this.dataset.nombreape + "?");

			if (confirmar) {
				var p = {
					servicio: "eliminaProfe",
					id: this.dataset.idprof
				}

				var parametros = {
					method: 'POST', body: JSON.stringify(p)
				};

				fetch(url, parametros)
					.then(r => r.json())
					.then(datosprof => creaTablaProf(datosprof));
			}


		}
	</script>
</head>

<body>
	<h1>Registro de Usuarios</h1>
	<form>
		<br>
		<button class="btn" id="btNuevoDepto" type="button">Nuevo Departamento</button>
		<p>
		<div id="departamentos">
			<table border="1">
				<thead>
					<tr>
						<th>ID</th>
						<th>NOMBRE</th>
						<th>DESCRIPCION</th>
						<th>Acción</th>
					</tr>
				</thead>

				<tbody id="detalle_departamentos">

				</tbody>


			</table>
		</div>
		</p>


		<div id="formDeptos" class="formProfes">
			<fieldset>
				<legend>Nuevo Departamento</legend>
				<div>
					<label for="nombreDepto">Nombre</label>
					<input type="text" id="nombreDepto" />
				</div>

				<div>
					<label for="descripcion">Descripcion</label>
					<textarea id="descripcion"></textarea>
				</div>
				<div class="btn">
					<button id="btAnadeDepto" type="button">Añadir </button>
					<button id="btCancelarDepto" type="button">Cancelar </button>
				</div>
			</fieldset>
		</div>


		<br />
		<br />
		Tabla de Profesores. Departamento de <span id="deptoDelProfe"></span>:
		<br><br>
		<button class="btn" id="btNuevaProfe" type="button">Nueva profe</button>

		<p>
		<div id="profesores">
			<table border="1">
				<thead>
					<tr>
						<th>ID</th>
						<th>DNI</th>
						<th>NOMBRE</th>
						<th>APELLIDOS</th>
						<th>Eliminar</th>
						<th>Editar</th>
					</tr>
				</thead>

				<tbody id="detalle_profesores">

				</tbody>


			</table>
		</div>
		</p>


		<div id="formProfes" class="formProfes">
			<fieldset>
				<legend>Alta en el servicio</legend>
				<div>
					<label for="dni">DNI</label>
					<input type="text" id="dni" size="10" maxlength="9" />
				</div>
				<div>
					<label for="nombre">Nombre</label>
					<input type="text" id="nombre" />
				</div>
				<div>
					<label for="apellidos">Apellidos</label>
					<input type="text" id="apellidos" size="40" />
				</div>
				<div class="btn">
					<button id="btAnade" type="button" data-idprofe="-1">Añadir </button>
					<button id="btCancelar" type="button">Cancelar </button>
				</div>
			</fieldset>
		</div>

	</form>

</body>

</html>